<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Usuários</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f8f8f8; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: left; }
    th { background: #eee; }
    select { padding: 4px; }
    .msg {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
      min-height: 24px;
    }
    .msg.success { color: green; }
    .msg.error { color: red; }
  </style>
</head>
<body>
  <h2>Gerenciar Papéis de Usuários</h2>
  <div id="user-table">Carregando usuários...</div>
  <div class="msg" id="msg"></div>

  <script type="module" src="./js/firebase.js"></script>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import {
      collection, getDocs, getDoc, updateDoc, doc, deleteField
    } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    const userTable = document.getElementById("user-table");
    const msgBox = document.getElementById("msg");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        userTable.innerHTML = "<p>Você precisa estar logado para ver essa página.</p>";
        return;
      }

      try {
        const userDocRef = doc(db, "users", user.email);
        const userSnap = await getDoc(userDocRef);

        if (!userSnap.exists() || userSnap.data().role !== "admin") {
          userTable.innerHTML = "<p>Acesso negado. Apenas administradores podem ver esta página.</p>";
          return;
        }

        renderUserTable(user.email);
      } catch (err) {
        userTable.innerHTML = "<p>Erro ao verificar permissões.</p>";
        console.error(err);
      }
    });

    async function renderUserTable(loggedUserEmail) {
      const usersRef = collection(db, "users");
      const snapshot = await getDocs(usersRef);
      let html = `<table><tr><th>Email</th><th>Nome</th><th>Papel</th></tr>`;

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const id = docSnap.id;
        const nome = data.nome || "-";
        const papel = data.role || "user";

        html += `
          <tr>
            <td>${id}</td>
            <td>${nome}</td>
            <td>
              <select data-id="${id}" class="role-select" ${id === loggedUserEmail ? 'title="Você não pode mudar seu próprio papel"' : ''}>
                <option value="user" ${papel === "user" ? "selected" : ""}>User</option>
                <option value="admin" ${papel === "admin" ? "selected" : ""}>Admin</option>
              </select>
            </td>
          </tr>
        `;
      });

      html += `</table>`;
      userTable.innerHTML = html;

      // Evento de alteração de papel
      document.querySelectorAll(".role-select").forEach(select => {
        select.setAttribute('data-old-role', select.value);

        select.addEventListener("change", async (e) => {
          const userId = e.target.dataset.id;
          const newRole = e.target.value;

          if (userId === auth.currentUser.email && newRole !== "admin") {
            alert("Você não pode remover seu próprio papel de admin.");
            e.target.value = "admin";
            return;
          }

          if (!confirm(`Confirma mudar o papel de ${userId} para ${newRole}?`)) {
            e.target.value = e.target.getAttribute('data-old-role') || "user";
            return;
          }

          e.target.disabled = true;
          setMsg("Atualizando...", "info");

          try {
            const userRef = doc(db, "users", userId);

            if (newRole === "user") {
              await updateDoc(userRef, { role: deleteField() }); // remove o campo role
            } else {
              await updateDoc(userRef, { role: newRole }); // define o novo papel
            }

            setMsg(`Papel de ${userId} atualizado para ${newRole}`, "success");
            e.target.setAttribute('data-old-role', newRole);
          } catch (err) {
            setMsg(`Erro ao atualizar papel de ${userId}`, "error");
            console.error(err);
            e.target.value = e.target.getAttribute('data-old-role') || "user";
          } finally {
            e.target.disabled = false;
            setTimeout(() => clearMsg(), 4000);
          }
        });
      });
    }

    function setMsg(text, type) {
      msgBox.textContent = text;
      msgBox.className = "msg";
      if (type === "success") msgBox.classList.add("success");
      else if (type === "error") msgBox.classList.add("error");
      else if (type === "info") msgBox.classList.add("info");
    }

    function clearMsg() {
      msgBox.textContent = "";
      msgBox.className = "msg";
    }
  </script>
</body>
</html>
